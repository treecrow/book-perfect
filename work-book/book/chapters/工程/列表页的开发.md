# 列表页的开发

> 列表页包含：筛选条件的表单元素、搜索按钮、

## 列表页元素列表

| 元素               | 推荐元素具柄    | more |
| ------------------ | --------------- | ---- |
| 筛选条件的表单元素 | -               | -    |
| 搜索按钮           | #searchBtn      | -    |
| 分页               | #pagination     | -    |
| 列表容器           | #pageListVessel | -    |
| 列表模板           | #pageListTpl    | -    |

## 相关文件引用

```html
<!-- 分页 -->
<script src="http://s.xnimg.cn/rrcar/modules/operationplatform/core/js/plugins/jquery.twbsPagination.min.js?ver=$revxxx$"></script>
<!-- 模版引擎 -->
<script src="http://s.xnimg.cn/rrcar/modules/operationplatform/core/js/plugins/template.js?ver=$revxxx$"></script>
<!-- 提示框 -->
<script src="http://s.xnimg.cn/rrcar/modules/operationplatform/core/js/plugins/bootbox.js?ver=$revxxx$"></script>
<!-- PageList -->
<script src="~/PageList.js?ver=$revxxx$"></script>
```

## Tools  方法集合

| method                                  | more                                                                                                                                                                         |
| --------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Tools.getUrlParam(key[,defaultVal])     | 用于获取 url 上面对应的请求参数,没有 key 对应的请求参数返回 defaultVal，如果 defaultVal 没有传入则返回空字符串，如果 defaultVal 为数字类型，该方法会将返回的结果转化为数字。 |
| Tools.updateSelect(ele,optionMap[,val]) | 将 下拉列表数据 optionMap 渲染到元素 ele 上，可设置下拉列表的值为 val                                                                                                        |

## 页面 js 编写

### 定义全局对象

> 定义全局对象，并根据 url 生成页面初次请求的参数。

```javascript
var whole = {
  initParams: {
    cityId: Tools.getUrlParam("cityId", 0), // 城市
    companyId: Tools.getUrlParam("companyId", 0), // 车商
    // 其它非表单默认请求参数
    pageSize: 10
  }
};
```

### 更新下拉列表表单示例

> 车商列表根据城市列表联动，这种情况下，更新车商列表就需要城市

```javascript
// 更新城市列表
function updateCitySelect(cityId) {
  cityId = cityId || 0;
  $.ajax({
    method: "get",
    url: "/api/select/city",
    dataType: "json",
    async: false,
    success: function(data) {
      if (data.result !== 200) {
        Tools.sendHint(data.msg);
        return;
      }
      var cityList = [{ key: "全部", value: 0 }];
      data.data.forEach(function(item) {
        cityList.push({ value: item.id, key: item.name });
      });
      Tools.updateSelect("#city", cityList, cityId);
    }
  });
}

// 更新车商列表
function updateCompanySelect(cityId, companyId) {
  cityId = cityId || 0;
  companyId = companyId || 0;
  $.ajax({
    method: "get",
    url: "/api/select/company",
    dataType: "json",
    data: {
      cityId: cityId
    },
    async: false,
    success: function(data) {
      if (data.result !== 200) {
        Tools.sendHint(data.msg);
        return;
      }
      var companyList = [{ key: "全部", value: 0 }];
      data.data.forEach(function(item) {
        companyList.push({ value: item.id, key: item.name });
      });
      Tools.updateSelect("#company", companyList, companyId);
    }
  });
}
```

### 定义全局对象

```javascript
(function() {
  // 定义全局对象，并整理url参数
  var whole = {
    initParams: {
      cityId: Tools.getUrlParam("cityId", 0), // 城市
      companyId: Tools.getUrlParam("companyId", 0), // 车商
      pageSize: 10
    }
  };

  // 更新城市列表
  function updateCitySelect(cityId) {
    cityId = cityId || 0;
    $.ajax({
      method: "get",
      url: "/api/select/city",
      dataType: "json",
      async: false,
      success: function(data) {
        if (data.result !== 200) {
          Tools.sendHint(data.msg);
          return;
        }
        var cityList = [{ key: "全部", value: 0 }];
        data.data.forEach(function(item) {
          cityList.push({ value: item.id, key: item.name });
        });
        Tools.updateSelect("#city", cityList, cityId);
      }
    });
  }

  // 更新车商列表
  function updateCompanySelect(cityId, companyId) {
    cityId = cityId || 0;
    companyId = companyId || 0;
    $.ajax({
      method: "get",
      url: "/api/select/company",
      dataType: "json",
      data: {
        cityId: cityId
      },
      async: false,
      success: function(data) {
        if (data.result !== 200) {
          Tools.sendHint(data.msg);
          return;
        }
        var companyList = [{ key: "全部", value: 0 }];
        data.data.forEach(function(item) {
          companyList.push({ value: item.id, key: item.name });
        });
        Tools.updateSelect("#company", companyList, companyId);
      }
    });
  }

  // 表单初始化
  function formInit() {
    // 城市
    updateCitySelect(whole.initParams.cityId);
    // 车商
    updateCompanySelect(whole.initParams.cityId, whole.initParams.companyId);
    // 合同编号
    $("#contractNo").val(whole.initParams.contractNo);
    // 当前状态
    $("#status").val(whole.initParams.status);
    // 销售业务单号
    $("#saleNum").val(whole.initParams.saleNum);
    // 手机号
    $("#phone").val(whole.initParams.phone);
    // 城市选择
    $("#city").on("change", function() {
      updateCompanySelect($(this).val());
    });
    // 渲染时间表单
    var initTimeVal = "";
    if (whole.initParams.startTime && whole.initParams.endTime) {
      initTimeVal =
        whole.initParams.startTime + " - " + whole.initParams.endTime;
    }
    laydate.render({
      elem: "#time",
      theme: "#e49700",
      value: initTimeVal,
      range: true
    });
  }

  $(function() {
    // 表单初始化
    formInit();

    // 初始化列表
    new PageList({
      // 页面初始参数(&& 默认参数)
      initParams: whole.initParams,
      // 获取表单参数
      getFormParams: function() {
        return {
          cityId: $("#city").val(),
          companyId: $("#company").val(),
          contractNo: $("#contractNo").val(),
          status: $("#status").val(),
          saleNum: $("#saleNum").val(),
          phone: $("#phone").val(),
          startTime: $("#time")
            .val()
            .split(" - ")[0],
          endTime: $("#time")
            .val()
            .split(" - ")[1]
        };
      },
      // 搜索按钮具柄
      searchBtn: "#searchBtn",
      // api 接口配置
      ajaxConfig: {
        method: "post",
        listQueryUrl: "/business/businessList",
        handleData: function(data) {
          var data = data.data;
          $("#totalRecord").text("（共 " + data.totalNum + " 条记录）");
          var listData = data.contents.map(function(item) {
            item.createTime = Tools.getExactDate(item.createTime);
            item.status = [
              "",
              "待提交",
              "待审批",
              "被驳回",
              "待收款",
              "收款中",
              "已全款",
              "已取消"
            ][item.status];
            return item;
          });
          return {
            totalPage: data.totalPage,
            listData: listData
          };
        }
      },
      // 表格具柄
      tableHandles: {
        vessel: "#pageListVessel",
        tpl: "#pageListTpl",
        pagination: "#pagination"
      }
    });
  });
})();
```
