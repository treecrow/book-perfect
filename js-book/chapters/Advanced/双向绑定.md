# 双向绑定

## 不同框架实现双向绑定对比

| @   | Backbone(发布者-订阅者模式) | AngularJS(脏值检查) | VueJS(数据劫持)                           |
|-----|---------------------|-----------------|---------------------------------------|
| MV  | 监听 Model change事件   | 脏值检测            | 通过Object.defineProperty() 方法，监控对数据的操作 |
| VM  | 监听 DOM 元素的各种事件      | 手动出发脏值检测        | 不需要                                   |

## vue 双向绑定大致原理

```js
function defineReactive(obj, key, value) {
  var dep = new Dep()
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter() {
      if (Dep.target) {
        dep.depend()
      }
      return value
    },
    set: function reactiveSetter(newVal) {
      if (value === newVal) {
        return
      } else {
        value = newVal
        dep.notify()
      }
    }
  })
}
```

### 读取数据

1. 如果当前对象有 Watcher(用于将新的数据发给视图)；
2. 将该 Watcher 绑定到当前的数据上(dep.depend()，会根据依赖获取最新值);
3. 将值返回。

### 赋值

1. 如果数据发生改变，则通知所有的 Watcher( dep.notify())；
2. 相关的 Watcher 会将新的数据发给视图。

## Vue 是如何识别出数据与视图的绑定关系？

> compile 过程中，对于给定的目标元素进行解析，识别出所有绑定在元素（通过 el 属性传入）上的指令

> link 过程中，建立这些指令与对应数据（通过 data 属性传入初始值）的绑定关系，并以数据的初始值进行渲染

## 双向绑定简单实现

### 相关实现

- [simply-vue](https://github.com/luobotang/simply-vue)
- [剖析vue实现原理，自己动手实现mvvm](https://github.com/DMQ/mvvm)

### 实现mvvm双向绑定的几个要点

- Observer---数据监听器，能够对数据对象的所有属性进行监听，如有变动可拿到最新值并通知订阅者
- Compile---指令解析器，对每个元素节点的指令进行扫描和解析，根据指令模板替换数据，以及绑定相应的更新函数；
- Watcher---连接Observer和Compile的桥梁，能够订阅并收到每个属性变动的通知，执行指令绑定的相应回调函数，从而更新视图；
- mvvm入口函数
