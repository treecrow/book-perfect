# 异步编程

## Promises

### Promise 包装一个回调函数，在里面调用原来的函数

```javascript
let getDevices = ()=> {
  return new Promise((resolve, reject)=> {
    this.request
      .post('https://user-openapi.hekr.me/irdainfo')
      .set('Content-Type', 'application/json')
      .set('Accept', 'application/json')
      .set('Authorization', `Bearer ${this.wholeCorrespond.accessToken}`)
      .send({
        "action": "IRA0",
        "type": irType,
        "code": irCode
      })
      .end((err, res)=> {
        if (err || !res.ok) {
          this.$router.replace({name: "fail"});
          reject('获取设备集合失败:' + JSON.stringify(err, null, 2));
        } else {
          let data = res.body;
          if (data.action === "IRA1") {
            console.log('成功获取设备集合');
            resolve(data.irdaInfo);
          }
        }
      });
  });
};
//promise2 获取某个设备的红外码库
let getOrderGather = (devices)=> {
  let targetDevice = devices[0];
  return new Promise((resolve, reject)=> {
    this.request
      .post('https://user-openapi.hekr.me/irdainfo')
      .set('Content-Type', 'application/json')
      .set('Accept', 'application/json')
      .set('Authorization', `Bearer ${this.wholeCorrespond.accessToken}`)
      .send({
        "action": "IRB0",
        "typeId": targetDevice.typeId
      })
      .end((err, res)=> {
        if (err || !res.ok) {
          this.$router.replace({name: "fail"});
          reject("请求单条设备红外码库失败！");
        } else {
          console.log('请求单条设备红外码库成功');

          let data = res.body;
          console.log('红外码库:' + JSON.stringify(data, null, 2));
          targetDevice.orderGather = data.set;
          if (targetDevice.devType === "AC") {
            targetDevice.reckonState = this.getAirParams(targetDevice.status);
            targetDevice.area = this.getAirArea(data.param);
          }
          this.addDevice(targetDevice);
          this.$router.replace({
            name: targetDevice.devType === "AC" ? "air" : "teeve",
            params: {
              id: targetDevice.typeId
            }
          });
          resolve();
        }
      });
  });
};
getDevices().then((devices)=> {
  console.log('获取的所有devices：' + JSON.stringify(devices, null, 2));
  return getOrderGather(devices);
}).catch((errMessage)=> {
  console.log(errMessage);
});
```

### 同时提供回调函数和 Promise 接口

```javascript
function foo(cb) {  
  if (cb) {
    return cb();
  }
  return new Promise(function (resolve, reject) {

  });
}
```
