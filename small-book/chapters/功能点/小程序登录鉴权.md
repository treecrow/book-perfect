# 小程序登录鉴权

## 相关文档

| api / 文档                                                                                            | more              |
| ----------------------------------------------------------------------------------------------------- | ----------------- |
| [小程序登录](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/login.html)      | 小程序登录流程图  |
| [wx.login()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.login.html)       | 获取登陆凭证 code |
| [code2Session](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html) | 登录凭证校验      |

## 登录鉴权流程

1. 客户端调用 wx.login 获取 code发给服务器
2. 服务器发送 appid+appseret+code 调取微信登录凭证校验接口
3. 微信后台返回给服务器 session_key+openid
4. 服务器自定义登录态（与 session_key+openid 相关联）
5. 服务器返回给客户端自定义的登录态
6. 客户端获取自定义登录态，存入 storage
7. 客户端 wx.request() 发起业务请求时携带自定义登录态

## checkSession

1. 小程序启动 onLaunch 判断 storage 中是否存在 skey
2. 存在，调取[wx.checkSession()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.htmlhttps://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/wx.checkSession.html)检查登录态是否过期
3. 验证登录态没有过期，开始业务请求
4. 验证过期，重新登录
5. 没有 skey，重新登录
