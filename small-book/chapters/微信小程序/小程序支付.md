# 小程序支付

## 相关文档

- [小程序支付文档](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_10&index=1)

## 相关 api

| api                                                                                                                 | more                                                                                                                        |
| ------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| [code2Session](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/login/code2Session.html)               | 登录凭证校验，使用 appid、secret、js_code、grant_type 等信息向微信后台请求 session_key、openid等信息                        |
| [统一下单 api](https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=9_1&index=1)                          | 请求接口需要 appid、mch_id、nonce_str、sign、body、out_trade_no、total_fee、spbill_create_ip、notify_url、trade_type 等参数 |
| [wx.requestPayment()](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/payment/wx.requestPayment.html) | 发起微信支付，需要 appid、mch_id、transaction_id、nonce_str、sign_type、sign                                                |

## 小程序支付业务流程

1. 向服务器请求下单支付
2. 服务器向微信后台调用小程序登录 api，获取 Openid
3. 服务器生成商户订单
4. 服务器向微信后台调用支付统一下单 api
5. 微信后台向服务器返回预付单信息（包含prepay_id）
6. 服务器将组合信息再次签名，并返回给客户端支付参数（5个参数和sign）
7. 用户在客户端确认支付
8. 客户端鉴权调起支付
9. 微信后台向客户端返回支付结果
10. 微信后台向服务器推送支付结果
11. 服务器更新订单状态